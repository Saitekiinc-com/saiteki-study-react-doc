name: Generate Learning Roadmap (RAG)

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'お名前 (例: 山田太郎)'
        required: true
        default: '山田太郎'
        type: string
      role:
        description: '役割 (例: Frontend Engineer)'
        required: true
        default: 'Frontend Engineer'
        type: string
      experience:
        description: '経験年数 (例: 3年)'
        required: true
        default: '3年'
        type: string
      goal:
        description: '現在の課題/ゴール'
        required: true
        default: 'バックエンドの設計がわからず、APIの修正依頼ができない。BFFやDB設計を学びたい。'
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @google/generative-ai glob dotenv

      - name: Update Vectors (Just-in-Time)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/update-vectors.js

      - name: Generate Roadmap
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USER_REQUEST: |
            【お名前】: ${{ inputs.name }}
            【役割】: ${{ inputs.role }}
            【経験年数】: ${{ inputs.experience }}
            【現在の課題/ゴール】: ${{ inputs.goal }}
        run: |
          # Run script and capture output to a temporary file
          node scripts/generate-roadmap.js > roadmap_output.md

          # Extract only the Markdown part (after "--- Generated Roadmap ---")
          # Note: The script prints logs to stdout too, so we need to be careful.
          # Let's adjust the script to print logs to stderr and only result to stdout,
          # OR just grep the content. For simplicity, let's assume the script prints logs first.
          # A safer way is to have the script write to a specific file, but let's try to parse.

          # For now, let's just use the whole output but strip the logs if possible.
          # Run script (it now writes to roadmap_body.md)
          node scripts/generate-roadmap.js

      - name: Ensure Label Exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "learning-roadmap" --color "0E8A16" --description "Generated learning roadmap" || true

      - name: Create Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "${{ inputs.name }}さん向け学習本の紹介" \
            --body-file roadmap_body.md \
            --label "learning-roadmap"
