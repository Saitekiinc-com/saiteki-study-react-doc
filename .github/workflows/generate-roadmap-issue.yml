name: Generate Roadmap from Issue

on:
  issues:
    types: [opened]

jobs:
  generate:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'roadmap-request')
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @google/generative-ai glob dotenv

      - name: Update Vectors (Just-in-Time)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/update-vectors.js

      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;

            // Helper to extract value from Issue Form body
            // Issue Forms format: ### Label\n\nValue\n\n
            function extractValue(label) {
              const regex = new RegExp(`### ${label}\\s+([\\s\\S]*?)(?:###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const name = extractValue('お名前');
            const role = extractValue('役割 (Role)');
            const experience = extractValue('経験年数');
            const goal = extractValue('現在の課題 / ゴール');

            core.setOutput('name', name);
            core.setOutput('role', role);
            core.setOutput('experience', experience);
            core.setOutput('goal', goal);

      - name: Generate Roadmap
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USER_REQUEST: |
            【お名前】: ${{ steps.parse.outputs.name }}
            【役割】: ${{ steps.parse.outputs.role }}
            【経験年数】: ${{ steps.parse.outputs.experience }}
            【現在の課題/ゴール】: ${{ steps.parse.outputs.goal }}
        run: |
          # Run script (writes to roadmap_body.md)
          node scripts/generate-roadmap.js

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body-file roadmap_body.md
