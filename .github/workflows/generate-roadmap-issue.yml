name: Generate Roadmap from Issue

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'roadmap-request')
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @google/generative-ai glob dotenv

      - name: Update Vectors (Just-in-Time)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/update-vectors.js

      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;

            // Helper to extract value from Issue Form body
            // Issue Forms format: ### Label\n\nValue\n\n
            function extractValue(label) {
              const regex = new RegExp(`### ${label}\\s+([\\s\\S]*?)(?:###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const name = extractValue('ãŠåå‰');
            const role = extractValue('å½¹å‰² (Role)');
            const experience = extractValue('çµŒé¨“å¹´æ•°');
            const current_understanding = extractValue('ã‚ã‹ã£ã¦ã„ã‚‹ã“ã¨ \\(Current Understanding\\)');
            const current_unknowns = extractValue('ã‚ã‹ã£ã¦ã„ãªã„ã“ã¨ \\(Current Challenges/Unknowns\\)');
            const objective = extractValue('é”æˆã—ãŸã„ç›®æ¨™ \\(Objective / Goal\\)');

            core.setOutput('name', name);
            core.setOutput('role', role);
            core.setOutput('experience', experience);
            core.setOutput('current_understanding', current_understanding);
            core.setOutput('current_unknowns', current_unknowns);
            core.setOutput('objective', objective);

      - name: Generate Roadmap
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USER_REQUEST: |
            ã€ãŠåå‰ã€‘: ${{ steps.parse.outputs.name }}
            ã€å½¹å‰²ã€‘: ${{ steps.parse.outputs.role }}
            ã€çµŒé¨“å¹´æ•°ã€‘: ${{ steps.parse.outputs.experience }}
            ã€ã‚ã‹ã£ã¦ã„ã‚‹ã“ã¨ã€‘: ${{ steps.parse.outputs.current_understanding }}
            ã€ã‚ã‹ã£ã¦ã„ãªã„ã“ã¨ã€‘: ${{ steps.parse.outputs.current_unknowns }}
            ã€é”æˆã—ãŸã„ç›®æ¨™ã€‘: ${{ steps.parse.outputs.objective }}
        run: |
          # Run script (writes to roadmap_body.md)
          node scripts/generate-roadmap.js

      - name: Rename Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          USER_NAME: ${{ steps.parse.outputs.name }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --title "ğŸ—º ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ä¾é ¼: ${USER_NAME}ã•ã‚“"

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body-file roadmap_body.md
